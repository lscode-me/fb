# –ì–ª–∞–≤–∞ 15. –ö–æ–¥–∏—Ä–æ–≤–∫–∏ –≤ Python

## –í–≤–µ–¥–µ–Ω–∏–µ

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è Unicode –∏ UTF-8 –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–∏ –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ. Python ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–∫—Å—Ç–æ–º, –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–¥–∏—Ä–æ–≤–∫–∏, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ª—é–±–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.

---

## 15.1 Python 2 vs Python 3: —Ä–µ–≤–æ–ª—é—Ü–∏—è –≤ —Ä–∞–±–æ—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º

### –ü—Ä–æ–±–ª–µ–º–∞ Python 2

–í Python 2 —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ —Å–º–µ—à–µ–Ω–∏–µ –ø–æ–Ω—è—Ç–∏–π:

```python
# Python 2
>>> type("hello")
<type 'str'>          # –≠—Ç–æ –±–∞–π—Ç—ã!

>>> type(u"hello")
<type 'unicode'>      # –≠—Ç–æ —Ç–µ–∫—Å—Ç

>>> "–ø—Ä–∏–≤–µ—Ç"          # –ë–∞–π—Ç—ã –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
'\xd0\xbf\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82'

>>> u"–ø—Ä–∏–≤–µ—Ç"         # Unicode —Å—Ç—Ä–æ–∫–∞
u'\u043f\u0440\u0438\u0432\u0435\u0442'
```

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º –æ—à–∏–±–∫–∞–º:

```python
# Python 2 ‚Äî —Ç–∏–ø–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞
>>> "hello" + u"–º–∏—Ä"
Traceback (most recent call last):
UnicodeDecodeError: 'ascii' codec can't decode byte 0xd0
```

### –†–µ—à–µ–Ω–∏–µ –≤ Python 3

Python 3 —á—ë—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–∏–ª –ø–æ–Ω—è—Ç–∏—è:

| –¢–∏–ø | –°–æ–¥–µ—Ä–∂–∏—Ç | –õ–∏—Ç–µ—Ä–∞–ª |
|-----|----------|---------|
| `str` | Unicode —Ç–µ–∫—Å—Ç (code points) | `"hello"`, `"–ø—Ä–∏–≤–µ—Ç"` |
| `bytes` | –°—ã—Ä—ã–µ –±–∞–π—Ç—ã | `b"hello"`, `b"\xd0\xbf"` |

```python
# Python 3
>>> type("–ø—Ä–∏–≤–µ—Ç")
<class 'str'>         # –≠—Ç–æ —Ç–µ–∫—Å—Ç (Unicode)

>>> type(b"hello")
<class 'bytes'>       # –≠—Ç–æ –±–∞–π—Ç—ã

>>> "–ø—Ä–∏–≤–µ—Ç"
'–ø—Ä–∏–≤–µ—Ç'              # –ß–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç

>>> "–ø—Ä–∏–≤–µ—Ç".encode('utf-8')
b'\xd0\xbf\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82'
```

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ: —Å–µ—Ç–µ–≤–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ `str`/`bytes` –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å **—Å–µ—Ç—å—é**. –°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã (HTTP, SMTP, FTP) –ø–µ—Ä–µ–¥–∞—é—Ç **–±–∞–π—Ç—ã**, –∞ –Ω–µ —Ç–µ–∫—Å—Ç:

```python
# Python 2 ‚Äî —Ä–∞–±–æ—Ç–∞–ª–æ —Å–ª—É—á–∞–π–Ω–æ
import socket
s = socket.socket()
s.connect(("example.com", 80))
s.send("GET / HTTP/1.0\r\n\r\n")  # str = –±–∞–π—Ç—ã, ¬´–ø–æ–≤–µ–∑–ª–æ¬ª

# Python 3 ‚Äî —è–≤–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
import socket
s = socket.socket()
s.connect(("example.com", 80))
s.send(b"GET / HTTP/1.0\r\nHost: example.com\r\n\r\n")  # bytes!
response = s.recv(4096)  # ‚Üí bytes
text = response.decode("utf-8", errors="replace")  # ‚Üí str
```

```bash
# –ê–Ω–∞–ª–æ–≥ –≤ shell ‚Äî telnet –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–π—Ç—ã ¬´–∫–∞–∫ –µ—Å—Ç—å¬ª
$ echo -e "GET / HTTP/1.0\r\nHost: example.com\r\n\r\n" | nc example.com 80
```

!!! warning "–ü—Ä–∞–≤–∏–ª–æ Python 3"
    –í—Å—ë, —á—Ç–æ —É—Ö–æ–¥–∏—Ç –≤ **—Å–µ—Ç—å, —Ñ–∞–π–ª –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å** ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `bytes`.
    –í—Å—ë, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é** ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `str`.
    –ì—Ä–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É –Ω–∏–º–∏ ‚Äî `encode()`/`decode()`.

---

## 15.2 str –∏ bytes: –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –º–∏—Ä–∞

### str ‚Äî —ç—Ç–æ —Ç–µ–∫—Å—Ç

`str` –≤ Python 3 ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å **Unicode code points**:

```python
text = "–ü—Ä–∏–≤–µ—Ç, ‰∏ñÁïå! üëã"

# –î–ª–∏–Ω–∞ ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ (code points)
>>> len(text)
14

# –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ —Å–∏–º–≤–æ–ª–∞–º
>>> text[0]
'–ü'
>>> text[8]
'‰∏ñ'
>>> text[13]
'üëã'

# –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ —Å–∏–º–≤–æ–ª–∞–º
>>> list(text)
['–ü', '—Ä', '–∏', '–≤', '–µ', '—Ç', ',', ' ', '‰∏ñ', 'Áïå', '!', ' ', 'üëã']
```

### bytes ‚Äî —ç—Ç–æ –±–∞–π—Ç—ã

`bytes` ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å **—Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª –æ—Ç 0 –¥–æ 255**:

```python
data = b"Hello"

>>> len(data)
5

>>> data[0]      # –ù–µ 'H', –∞ —á–∏—Å–ª–æ!
72

>>> list(data)
[72, 101, 108, 108, 111]
```

–î–ª—è –Ω–µ-ASCII —Å–∏–º–≤–æ–ª–æ–≤ –Ω—É–∂–Ω–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```python
>>> b"–ø—Ä–∏–≤–µ—Ç"
SyntaxError: bytes can only contain ASCII literal characters

>>> "–ø—Ä–∏–≤–µ—Ç".encode('utf-8')
b'\xd0\xbf\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82'
```

---

## 15.3 encode() –∏ decode(): –º–æ—Å—Ç –º–µ–∂–¥—É –º–∏—Ä–∞–º–∏

### –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: str ‚Üí bytes

```python
text = "–ü—Ä–∏–≤–µ—Ç"

# UTF-8 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
>>> text.encode()
b'\xd0\xbf\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82'

>>> text.encode('utf-8')
b'\xd0\xbf\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82'

# UTF-16
>>> text.encode('utf-16')
b'\xff\xfe?\x04@\x048\x042\x045\x04B\x04'

# UTF-32
>>> text.encode('utf-32')
b'\xff\xfe\x00\x00?\x04\x00\x00@\x04\x00\x008\x04\x00\x002\x04\x00\x005\x04\x00\x00B\x04\x00\x00'

# Windows-1251
>>> text.encode('cp1251')
b'\xcf\xf0\xe8\xe2\xe5\xf2'

# KOI8-R
>>> text.encode('koi8-r')
b'\xf0\xd2\xc9\xd7\xc5\xd4'
```

### –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: bytes ‚Üí str

```python
data = b'\xd0\xbf\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82'

>>> data.decode('utf-8')
'–ü—Ä–∏–≤–µ—Ç'

>>> data.decode()  # UTF-8 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
'–ü—Ä–∏–≤–µ—Ç'

# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ ‚Äî –∫—Ä–∞–∫–æ–∑—è–±—Ä—ã –∏–ª–∏ –æ—à–∏–±–∫–∞
>>> data.decode('cp1251')
'√ê¬ø√ë\x80√ê¬∏√ê¬≤√ê¬µ√ë\x82'

>>> data.decode('ascii')
UnicodeDecodeError: 'ascii' codec can't decode byte 0xd0
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```python
text = "–ü—Ä–∏–≤–µ—Ç"

# strict (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚Äî –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
>>> text.encode('ascii')
UnicodeEncodeError: 'ascii' codec can't encode characters

# ignore ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–µ–∫–æ–¥–∏—Ä—É–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã
>>> text.encode('ascii', errors='ignore')
b''

# replace ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ ?
>>> text.encode('ascii', errors='replace')
b'??????'

# xmlcharrefreplace ‚Äî XML-—Å—É—â–Ω–æ—Å—Ç–∏
>>> text.encode('ascii', errors='xmlcharrefreplace')
b'&#1055;&#1088;&#1080;&#1074;&#1077;&#1090;'

# backslashreplace ‚Äî escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
>>> text.encode('ascii', errors='backslashreplace')
b'\\u043f\\u0440\\u0438\\u0432\\u0435\\u0442'
```

---

## 15.4 –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏: —Ä–µ–∂–∏–º—ã –æ—Ç–∫—Ä—ã—Ç–∏—è

### –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```python
# –ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
with open('file.txt', 'r', encoding='utf-8') as f:
    text = f.read()     # str
    
# –ó–∞–ø–∏—Å—å —Ç–µ–∫—Å—Ç–∞
with open('file.txt', 'w', encoding='utf-8') as f:
    f.write('–ü—Ä–∏–≤–µ—Ç')   # str
    
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
with open('file.txt', 'a', encoding='utf-8') as f:
    f.write('\n–ú–∏—Ä')    # str
```

### –ë–∏–Ω–∞—Ä–Ω—ã–π —Ä–µ–∂–∏–º

```python
# –ß—Ç–µ–Ω–∏–µ –±–∞–π—Ç–æ–≤
with open('file.bin', 'rb') as f:
    data = f.read()     # bytes
    
# –ó–∞–ø–∏—Å—å –±–∞–π—Ç–æ–≤
with open('file.bin', 'wb') as f:
    f.write(b'\x00\x01\x02')  # bytes
    
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–π—Ç–æ–≤
with open('file.bin', 'ab') as f:
    f.write(b'\x03\x04')      # bytes
```

### –í—Å–µ —Ä–µ–∂–∏–º—ã –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–æ–≤

| –†–µ–∂–∏–º | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö |
|-------|----------|------------|
| `'r'` | –ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ | str |
| `'w'` | –ó–∞–ø–∏—Å—å —Ç–µ–∫—Å—Ç–∞ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å) | str |
| `'a'` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ | str |
| `'x'` | –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å (–æ—à–∏–±–∫–∞ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç) | str |
| `'rb'` | –ß—Ç–µ–Ω–∏–µ –±–∞–π—Ç–æ–≤ | bytes |
| `'wb'` | –ó–∞–ø–∏—Å—å –±–∞–π—Ç–æ–≤ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å) | bytes |
| `'ab'` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–π—Ç–æ–≤ | bytes |
| `'xb'` | –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –±–∞–π—Ç–æ–≤ | bytes |
| `'r+'` | –ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å —Ç–µ–∫—Å—Ç–∞ | str |
| `'w+'` | –ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å —Ç–µ–∫—Å—Ç–∞ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å) | str |
| `'rb+'` | –ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –±–∞–π—Ç–æ–≤ | bytes |
| `'wb+'` | –ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –±–∞–π—Ç–æ–≤ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å) | bytes |

### –í–∞–∂–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–¥–∏—Ä–æ–≤–∫–∏

```python
# –ü–õ–û–•–û ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π –ª–æ–∫–∞–ª–∏!
with open('file.txt', 'r') as f:
    text = f.read()
    
# –•–û–†–û–®–û ‚Äî —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏
with open('file.txt', 'r', encoding='utf-8') as f:
    text = f.read()
```

!!! warning "–ö–æ–¥–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
    –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å `encoding`, Python –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `locale.getpreferredencoding()`:
    - Linux/macOS: –æ–±—ã—á–Ω–æ UTF-8
    - Windows: cp1251, cp1252 –∏–ª–∏ –¥—Ä—É–≥–∞—è —Å–∏—Å—Ç–µ–º–Ω–∞—è

---

## 15.5 UTF-8, UTF-16, UTF-32: –∫–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### UTF-8

```python
text = "Hello, –º–∏—Ä! üëã"

encoded = text.encode('utf-8')
>>> len(encoded)
20

>>> encoded
b'Hello, \xd0\xbc\xd0\xb8\xd1\x80! \xf0\x9f\x91\x8b'
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞: 1‚Äì4 –±–∞–π—Ç–∞ –Ω–∞ —Å–∏–º–≤–æ–ª
- ASCII-—Å–æ–≤–º–µ—Å—Ç–∏–º (–ø–µ—Ä–≤—ã–µ 128 —Å–∏–º–≤–æ–ª–æ–≤ ‚Äî 1 –±–∞–π—Ç)
- –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø–æ—Ä—è–¥–∫–æ–º –±–∞–π—Ç–æ–≤ (endianness)
- **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤**

### UTF-16

```python
text = "Hello, –º–∏—Ä! üëã"

# –° BOM (Byte Order Mark)
>>> text.encode('utf-16')
b'\xff\xfeH\x00e\x00l\x00l\x00o\x00,\x00 \x00<\x044\x048\x04!\x00 \x00=\xd8K\xde'

# Little-endian –±–µ–∑ BOM
>>> text.encode('utf-16-le')
b'H\x00e\x00l\x00l\x00o\x00,\x00 \x00<\x044\x048\x04!\x00 \x00=\xd8K\xde'

# Big-endian –±–µ–∑ BOM
>>> text.encode('utf-16-be')
b'\x00H\x00e\x00l\x00l\x00o\x00,\x00 \x04<\x044\x048\x00!\x00 \xd8=\xdeK'
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞: 2 –∏–ª–∏ 4 –±–∞–π—Ç–∞ –Ω–∞ —Å–∏–º–≤–æ–ª
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Windows API, Java, JavaScript (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ)
- –¢—Ä–µ–±—É–µ—Ç —É–∫–∞–∑–∞–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –±–∞–π—Ç–æ–≤ (BOM –∏–ª–∏ —è–≤–Ω–æ LE/BE)

### UTF-32

```python
text = "Hello, –º–∏—Ä! üëã"

>>> text.encode('utf-32')
b'\xff\xfe\x00\x00H\x00\x00\x00e\x00\x00\x00l\x00\x00\x00...'

>>> len(text.encode('utf-32'))
52  # 4 –±–∞–π—Ç–∞ √ó 12 —Å–∏–º–≤–æ–ª–æ–≤ + 4 –±–∞–π—Ç–∞ BOM
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª–∏–Ω–∞: 4 –±–∞–π—Ç–∞ –Ω–∞ —Å–∏–º–≤–æ–ª
- –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è, –Ω–æ –±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä
- –†–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤

```python
text = "Hello, –º–∏—Ä! üëã"

print(f"UTF-8:  {len(text.encode('utf-8')):3} –±–∞–π—Ç")
print(f"UTF-16: {len(text.encode('utf-16')):3} –±–∞–π—Ç")
print(f"UTF-32: {len(text.encode('utf-32')):3} –±–∞–π—Ç")

# –í—ã–≤–æ–¥:
# UTF-8:   20 –±–∞–π—Ç
# UTF-16:  28 –±–∞–π—Ç
# UTF-32:  52 –±–∞–π—Ç
```

---

## 15.6 –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

### –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏

```python
import chardet

def read_file_auto(path):
    """–ß–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—è –∫–æ–¥–∏—Ä–æ–≤–∫—É."""
    with open(path, 'rb') as f:
        raw = f.read()
    
    detected = chardet.detect(raw)
    encoding = detected['encoding']
    confidence = detected['confidence']
    
    print(f"Detected: {encoding} (confidence: {confidence:.0%})")
    return raw.decode(encoding)
```

### –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –º–µ–∂–¥—É –∫–æ–¥–∏—Ä–æ–≤–∫–∞–º–∏

```python
def convert_encoding(input_path, output_path, 
                     from_encoding='cp1251', 
                     to_encoding='utf-8'):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –∏–∑ –æ–¥–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –≤ –¥—Ä—É–≥—É—é."""
    with open(input_path, 'r', encoding=from_encoding) as f:
        content = f.read()
    
    with open(output_path, 'w', encoding=to_encoding) as f:
        f.write(content)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
convert_encoding('old_file.txt', 'new_file.txt', 
                 from_encoding='cp1251', to_encoding='utf-8')
```

### –†–∞–±–æ—Ç–∞ —Å BOM

```python
import codecs

# –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å BOM
with open('file_with_bom.txt', 'r', encoding='utf-8-sig') as f:
    text = f.read()  # BOM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è

# –ó–∞–ø–∏—Å—å —Ñ–∞–π–ª–∞ —Å BOM (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Excel)
with open('for_excel.csv', 'w', encoding='utf-8-sig') as f:
    f.write('–ò–º—è,–í–æ–∑—Ä–∞—Å—Ç\n')
    f.write('–ò–≤–∞–Ω,30\n')
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π

```python
def safe_decode(data: bytes, encodings=None) -> str:
    """–ü—ã—Ç–∞–µ—Ç—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –±–∞–π—Ç—ã, –ø–µ—Ä–µ–±–∏—Ä–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∏."""
    if encodings is None:
        encodings = ['utf-8', 'cp1251', 'cp1252', 'iso-8859-1']
    
    for encoding in encodings:
        try:
            return data.decode(encoding)
        except UnicodeDecodeError:
            continue
    
    # Fallback: –¥–µ–∫–æ–¥–∏—Ä—É–µ–º —Å –∑–∞–º–µ–Ω–æ–π –æ—à–∏–±–æ–∫
    return data.decode('utf-8', errors='replace')
```

---

## 15.7 –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

### –û—à–∏–±–∫–∞ 1: –°–º–µ—à–∏–≤–∞–Ω–∏–µ str –∏ bytes

```python
# –û–®–ò–ë–ö–ê
>>> "Hello " + b"World"
TypeError: can only concatenate str (not "bytes") to str

# –†–ï–®–ï–ù–ò–ï
>>> "Hello " + b"World".decode('utf-8')
'Hello World'
```

### –û—à–∏–±–∫–∞ 2: –ó–∞–±—ã–ª–∏ —É–∫–∞–∑–∞—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É

```python
# –û–®–ò–ë–ö–ê ‚Äî –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
with open('file.txt') as f:
    text = f.read()

# –†–ï–®–ï–ù–ò–ï
with open('file.txt', encoding='utf-8') as f:
    text = f.read()
```

### –û—à–∏–±–∫–∞ 3: –î–≤–æ–π–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
text = "–ü—Ä–∏–≤–µ—Ç"

# –û–®–ò–ë–ö–ê ‚Äî –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–ª–∏ –¥–≤–∞–∂–¥—ã
>>> text.encode('utf-8').decode('latin-1').encode('utf-8')
b'\xc3\x90\xc2\xbf\xc3\x91\xc2\x80...'  # –ú—É—Å–æ—Ä

# –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å: decode + encode —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–æ–¥–∏—Ä–æ–≤–∫–∞–º–∏
>>> b'\xc3\x90\xc2\xbf...'.decode('utf-8').encode('latin-1').decode('utf-8')
'–ü—Ä–∏–≤–µ—Ç'
```

### –û—à–∏–±–∫–∞ 4: –ß—Ç–µ–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ

```python
# –û–®–ò–ë–ö–ê
with open('image.png', 'r') as f:
    data = f.read()  # UnicodeDecodeError!

# –†–ï–®–ï–ù–ò–ï
with open('image.png', 'rb') as f:
    data = f.read()  # bytes
```

---

## 15.8 –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –≤ Python

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–¥–∏—Ä–æ–≤–æ–∫

Python –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å –º–æ–¥—É–ª–µ–º `encodings`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º –≤—Å–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏:

```python
import pkgutil
import encodings

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–¥–∏—Ä–æ–≤–æ–∫
all_encodings = sorted([name for _, name, _ in pkgutil.iter_modules(encodings.__path__)])
print(all_encodings)
```

–†–µ–∑—É–ª—å—Ç–∞—Ç (Python 3.12):

```python
['aliases', 'ascii', 'base64_codec', 'big5', 'big5hkscs', 'bz2_codec', 
'charmap', 'cp037', 'cp1006', 'cp1026', 'cp1125', 'cp1140', 'cp1250', 
'cp1251', 'cp1252', 'cp1253', 'cp1254', 'cp1255', 'cp1256', 'cp1257', 
'cp1258', 'cp273', 'cp424', 'cp437', 'cp500', 'cp720', 'cp737', 'cp775', 
'cp850', 'cp852', 'cp855', 'cp856', 'cp857', 'cp858', 'cp860', 'cp861', 
'cp862', 'cp863', 'cp864', 'cp865', 'cp866', 'cp869', 'cp874', 'cp875', 
'cp932', 'cp949', 'cp950', 'euc_jis_2004', 'euc_jisx0213', 'euc_jp', 
'euc_kr', 'gb18030', 'gb2312', 'gbk', 'hex_codec', 'hp_roman8', 'hz', 
'idna', 'iso2022_jp', 'iso2022_jp_1', 'iso2022_jp_2', 'iso2022_jp_2004', 
'iso2022_jp_3', 'iso2022_jp_ext', 'iso2022_kr', 'iso8859_1', 'iso8859_10', 
'iso8859_11', 'iso8859_13', 'iso8859_14', 'iso8859_15', 'iso8859_16', 
'iso8859_2', 'iso8859_3', 'iso8859_4', 'iso8859_5', 'iso8859_6', 
'iso8859_7', 'iso8859_8', 'iso8859_9', 'johab', 'koi8_r', 'koi8_t', 
'koi8_u', 'kz1048', 'latin_1', 'mac_arabic', 'mac_croatian', 'mac_cyrillic', 
'mac_farsi', 'mac_greek', 'mac_iceland', 'mac_latin2', 'mac_roman', 
'mac_romanian', 'mac_turkish', 'mbcs', 'oem', 'palmos', 'ptcp154', 
'punycode', 'quopri_codec', 'raw_unicode_escape', 'rot_13', 'shift_jis', 
'shift_jis_2004', 'shift_jisx0213', 'tis_620', 'undefined', 
'unicode_escape', 'utf_16', 'utf_16_be', 'utf_16_le', 'utf_32', 
'utf_32_be', 'utf_32_le', 'utf_7', 'utf_8', 'utf_8_sig', 'uu_codec', 
'zlib_codec']
```

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É

```python
# –¢–æ–ª—å–∫–æ UTF –∫–æ–¥–∏—Ä–æ–≤–∫–∏
>>> [e for e in all_encodings if "utf" in e]
['utf_16', 'utf_16_be', 'utf_16_le', 'utf_32', 'utf_32_be', 
 'utf_32_le', 'utf_7', 'utf_8', 'utf_8_sig']

# –ö–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏
>>> [e for e in all_encodings if any(x in e for x in ['1251', 'koi8', '866', 'cyrillic'])]
['cp1251', 'cp866', 'koi8_r', 'koi8_t', 'koi8_u', 'mac_cyrillic']

# –Ø–ø–æ–Ω—Å–∫–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏
>>> [e for e in all_encodings if any(x in e for x in ['jp', 'jis', 'shift'])]
['euc_jis_2004', 'euc_jisx0213', 'euc_jp', 'iso2022_jp', 'iso2022_jp_1',
 'iso2022_jp_2', 'iso2022_jp_2004', 'iso2022_jp_3', 'iso2022_jp_ext',
 'shift_jis', 'shift_jis_2004', 'shift_jisx0213']
```

### –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –∫–æ–¥–∏—Ä–æ–≤–∫–∏?

–ö–æ–¥–∏—Ä–æ–≤–∫–∏ –≤ Python ‚Äî —ç—Ç–æ **—á–∞—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ CPython**, –∞ –Ω–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ. –û–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `Lib/encodings/` –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ Python:

```python
import encodings
import os

# –ü—É—Ç—å –∫ –º–æ–¥—É–ª—é encodings
>>> encodings.__path__
['/usr/lib/python3.12/encodings']

# –§–∞–π–ª—ã –∫–æ–¥–∏—Ä–æ–≤–æ–∫
>>> os.listdir(encodings.__path__[0])[:10]
['cp1251.py', 'utf_8.py', 'ascii.py', 'iso8859_1.py', ...]
```

–ö–∞–∂–¥—ã–π —Ñ–∞–π–ª ‚Äî —ç—Ç–æ Python-–º–æ–¥—É–ª—å, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –∫–æ–¥–µ–∫:

```python
# –ü—Ä–∏–º–µ—Ä: —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ cp1251.py
import codecs

class Codec(codecs.Codec):
    def encode(self, input, errors='strict'):
        return codecs.charmap_encode(input, errors, encoding_table)
    
    def decode(self, input, errors='strict'):
        return codecs.charmap_decode(input, errors, decoding_table)

# –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –±–∞–π—Ç ‚Üí —Å–∏–º–≤–æ–ª
decoding_table = (
    '\x00'    # 0x00 -> NULL
    '\x01'    # 0x01 -> ...
    # ... 256 —Å–∏–º–≤–æ–ª–æ–≤ ...
)
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏

–ú–æ–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥–µ–∫ —á–µ—Ä–µ–∑ `codecs.register()`:

```python
import codecs

def rot13_encode(text):
    """ROT13 ‚Äî —Å–¥–≤–∏–≥ –±—É–∫–≤ –Ω–∞ 13 –ø–æ–∑–∏—Ü–∏–π."""
    return codecs.encode(text, 'rot_13'), len(text)

def rot13_decode(data):
    return codecs.decode(data, 'rot_13'), len(data)

class Rot13Codec(codecs.Codec):
    def encode(self, input, errors='strict'):
        return rot13_encode(input)
    def decode(self, input, errors='strict'):
        return rot13_decode(input)

def find_rot13(encoding):
    if encoding == 'my_rot13':
        return codecs.CodecInfo(
            name='my_rot13',
            encode=Rot13Codec().encode,
            decode=Rot13Codec().decode,
        )
    return None

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
codecs.register(find_rot13)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
>>> "Hello".encode('my_rot13')
b'Uryyb'
>>> b'Uryyb'.decode('my_rot13')
'Hello'
```

---

## 15.9 –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∫–æ–¥–∏—Ä–æ–≤–æ–∫

### Unicode –∫–æ–¥–∏—Ä–æ–≤–∫–∏ (UTF)

| –ö–æ–¥–∏—Ä–æ–≤–∫–∞ | –ë–∞–π—Ç/—Å–∏–º–≤–æ–ª | BOM | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|-------------|-----|----------|
| `utf_8` | 1‚Äì4 | –ù–µ—Ç | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç, ASCII-—Å–æ–≤–º–µ—Å—Ç–∏–º |
| `utf_8_sig` | 1‚Äì4 | –î–∞ (EF BB BF) | UTF-8 —Å BOM –¥–ª—è Excel –∏ Windows |
| `utf_7` | 1‚Äì5+ | –ù–µ—Ç | –î–ª—è email (7-bit safe), —É—Å—Ç–∞—Ä–µ–ª |
| `utf_16` | 2‚Äì4 | –î–∞ | –° BOM, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –±–∞–π—Ç–æ–≤ |
| `utf_16_le` | 2‚Äì4 | –ù–µ—Ç | Little-endian –±–µ–∑ BOM |
| `utf_16_be` | 2‚Äì4 | –ù–µ—Ç | Big-endian –±–µ–∑ BOM |
| `utf_32` | 4 | –î–∞ | –° BOM |
| `utf_32_le` | 4 | –ù–µ—Ç | Little-endian –±–µ–∑ BOM |
| `utf_32_be` | 4 | –ù–µ—Ç | Big-endian –±–µ–∑ BOM |

### –ö–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏

| –ö–æ–¥–∏—Ä–æ–≤–∫–∞ | –ë–∞–π—Ç/—Å–∏–º–≤–æ–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|-------------|----------|
| `cp1251` | 1 | Windows Cyrillic (–†–æ—Å—Å–∏—è, –£–∫—Ä–∞–∏–Ω–∞, –ë–æ–ª–≥–∞—Ä–∏—è) |
| `cp866` | 1 | DOS Cyrillic (OEM) |
| `koi8_r` | 1 | KOI8-R (–†—É—Å—Å–∫–∏–π, UNIX legacy) |
| `koi8_u` | 1 | KOI8-U (–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π) |
| `iso8859_5` | 1 | ISO Latin/Cyrillic |
| `mac_cyrillic` | 1 | Mac OS Cyrillic |

### –ó–∞–ø–∞–¥–Ω–æ–µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏

| –ö–æ–¥–∏—Ä–æ–≤–∫–∞ | –ë–∞–π—Ç/—Å–∏–º–≤–æ–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|-------------|----------|
| `ascii` | 1 | 7-bit ASCII (0‚Äì127) |
| `latin_1` / `iso8859_1` | 1 | ISO Latin-1 (–ó–∞–ø–∞–¥–Ω–∞—è –ï–≤—Ä–æ–ø–∞) |
| `cp1252` | 1 | Windows Western (–Ω–∞–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ latin-1) |
| `iso8859_15` | 1 | Latin-9 (—Å —Å–∏–º–≤–æ–ª–æ–º ‚Ç¨) |
| `mac_roman` | 1 | Mac OS Roman |

### –í–æ—Å—Ç–æ—á–Ω–æ–∞–∑–∏–∞—Ç—Å–∫–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏

| –ö–æ–¥–∏—Ä–æ–≤–∫–∞ | –ë–∞–π—Ç/—Å–∏–º–≤–æ–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|-------------|----------|
| `gb2312` | 1‚Äì2 | –ö–∏—Ç–∞–π—Å–∫–∏–π (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π, –±–∞–∑–æ–≤—ã–π) |
| `gbk` | 1‚Äì2 | –ö–∏—Ç–∞–π—Å–∫–∏–π (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π GBK) |
| `gb18030` | 1‚Äì4 | –ö–∏—Ç–∞–π—Å–∫–∏–π (–ø–æ–ª–Ω—ã–π Unicode-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π) |
| `big5` | 1‚Äì2 | –ö–∏—Ç–∞–π—Å–∫–∏–π (—Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π, –¢–∞–π–≤–∞–Ω—å) |
| `shift_jis` | 1‚Äì2 | –Ø–ø–æ–Ω—Å–∫–∏–π (Windows) |
| `euc_jp` | 1‚Äì3 | –Ø–ø–æ–Ω—Å–∫–∏–π (UNIX) |
| `euc_kr` | 1‚Äì2 | –ö–æ—Ä–µ–π—Å–∫–∏–π (UNIX) |
| `cp949` | 1‚Äì2 | –ö–æ—Ä–µ–π—Å–∫–∏–π (Windows) |

### –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–¥–µ–∫–∏ (–Ω–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞)

| –ö–æ–¥–µ–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `base64_codec` | Base64 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ |
| `hex_codec` | –®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–µ—Ä–∏—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ |
| `bz2_codec` | –°–∂–∞—Ç–∏–µ bzip2 |
| `zlib_codec` | –°–∂–∞—Ç–∏–µ zlib |
| `quopri_codec` | Quoted-printable (email) |
| `uu_codec` | Uuencode (UNIX-to-UNIX) |
| `rot_13` | ROT13 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ |
| `unicode_escape` | Python Unicode escape (`\uXXXX`) |
| `raw_unicode_escape` | Raw Unicode escape |
| `punycode` | Punycode –¥–ª—è IDN (–¥–æ–º–µ–Ω—ã) |
| `idna` | IDNA –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–æ–≤ |

---

## 15.10 –û—Å–æ–±—ã–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏: –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏

### utf_8_sig ‚Äî UTF-8 —Å BOM

**BOM** (Byte Order Mark) ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞:

```python
# –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç BOM
>>> "–ü—Ä–∏–≤–µ—Ç".encode('utf-8-sig')
b'\xef\xbb\xbf–ü—Ä–∏–≤–µ—Ç'

# –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç BOM
>>> b'\xef\xbb\xbf\xd0\x9f\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82'.decode('utf-8-sig')
'–ü—Ä–∏–≤–µ—Ç'
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- CSV —Ñ–∞–π–ª—ã –¥–ª—è Excel (–∏–Ω–∞—á–µ Excel –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç UTF-8)
- –§–∞–π–ª—ã –¥–ª—è Windows-–ø—Ä–æ–≥—Ä–∞–º–º, –æ–∂–∏–¥–∞—é—â–∏—Ö BOM

```python
# CSV –¥–ª—è Excel
with open('data.csv', 'w', encoding='utf-8-sig', newline='') as f:
    writer = csv.writer(f)
    writer.writerow(['–ò–º—è', '–í–æ–∑—Ä–∞—Å—Ç'])
    writer.writerow(['–ü—ë—Ç—Ä', 30])
```

### utf_7 ‚Äî –¥–ª—è email (7-bit safe)

UTF-7 –∫–æ–¥–∏—Ä—É–µ—Ç Unicode, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ ASCII-—Å–∏–º–≤–æ–ª—ã. –ù—É–∂–µ–Ω –¥–ª—è —Å—Ç–∞—Ä—ã—Ö email-—Å–∏—Å—Ç–µ–º:

```python
>>> "–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!".encode('utf-7')
b'–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!'  # –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –∫–∞–∫ +BDAEQARLBDUEQgQ-...

>>> "–ü—Ä–∏–≤–µ—Ç".encode('utf-7')
b'+BDAEPAQ4BDIENQRC-'

# ASCII –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
>>> "Hello".encode('utf-7')
b'Hello'
```

**–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** ‚Äî —É—Å—Ç–∞—Ä–µ–ª, –∑–∞–º–µ–Ω—ë–Ω MIME –∏ base64.

### unicode_escape –∏ raw_unicode_escape

–ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤ Python escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```python
>>> "–ü—Ä–∏–≤–µ—Ç üëã".encode('unicode_escape')
b'\\u043f\\u0440\\u0438\\u0432\\u0435\\u0442 \\U0001f44b'

>>> b'\\u043f\\u0440\\u0438\\u0432\\u0435\\u0442'.decode('unicode_escape')
'–ø—Ä–∏–≤–µ—Ç'

# raw_unicode_escape ‚Äî –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç \n, \t –∏ —Ç.–¥.
>>> "Tab:\tNewline:\n".encode('unicode_escape')
b'Tab:\\tNewline:\\n'

>>> "Tab:\tNewline:\n".encode('raw_unicode_escape')
b'Tab:\tNewline:\n'
```

### punycode –∏ idna ‚Äî –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤

```python
# Punycode ‚Äî –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ IDN
>>> "m√ºnchen".encode('punycode')
b'mnchen-3ya'

>>> "–º–æ—Å–∫–≤–∞".encode('punycode')
b'80aafi6cg'

# IDNA ‚Äî –ø–æ–ª–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–∞
>>> "m√ºnchen.de".encode('idna')
b'xn--mnchen-3ya.de'

>>> "–ø–æ—á—Ç–∞.—Ä—Ñ".encode('idna')
b'xn--80a1acny.xn--p1ai'
```

### mbcs –∏ oem ‚Äî Windows-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ

```python
# mbcs ‚Äî Multi-Byte Character Set —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞–ª–∏ Windows
# –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ Linux/macOS

# oem ‚Äî OEM –∫–æ–¥–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Windows (–æ–±—ã—á–Ω–æ cp437 –∏–ª–∏ cp866)
```

### undefined ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–¥–µ–∫

–í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
>>> "test".encode('undefined')
UnicodeEncodeError: 'undefined' codec can't encode characters
```

---

## –†–µ–∑—é–º–µ

| –ö–æ–Ω—Ü–µ–ø—Ü–∏—è | Python 2 | Python 3 |
|-----------|----------|----------|
| –¢–µ–∫—Å—Ç | `unicode` | `str` |
| –ë–∞–π—Ç—ã | `str` | `bytes` |
| –õ–∏—Ç–µ—Ä–∞–ª —Ç–µ–∫—Å—Ç–∞ | `u"—Ç–µ–∫—Å—Ç"` | `"—Ç–µ–∫—Å—Ç"` |
| –õ–∏—Ç–µ—Ä–∞–ª –±–∞–π—Ç–æ–≤ | `"bytes"` | `b"bytes"` |
| –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | ASCII | UTF-8 |

**–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–∞–º–∏ –≤ Python 3:**

1. **–í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ `encoding`** –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ UTF-8** –µ—Å–ª–∏ –Ω–µ—Ç –æ—Å–æ–±—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
3. **–ù–µ —Å–º–µ—à–∏–≤–∞–π—Ç–µ `str` –∏ `bytes`** ‚Äî —è–≤–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ
4. **–î–µ–∫–æ–¥–∏—Ä—É–π—Ç–µ –Ω–∞ –≤—Ö–æ–¥–µ, –∫–æ–¥–∏—Ä—É–π—Ç–µ –Ω–∞ –≤—ã—Ö–æ–¥–µ** ‚Äî –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ä–∞–±–æ—Ç–∞–π—Ç–µ —Å `str`


??? question "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"
    **–ó–∞–¥–∞–Ω–∏–µ 1.** –ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `safe_read(path)`, –∫–æ—Ç–æ—Ä–∞—è –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –≤ UTF-8, –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –≤ CP1251, –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –≤ latin-1 (–≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `errors='strict'`.
    
    **–ó–∞–¥–∞–Ω–∏–µ 2.** –û—Ç–∫—Ä–æ–π—Ç–µ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å `encoding='utf-8'` –∏ `encoding='utf-8-sig'`. –í —á—ë–º —Ä–∞–∑–Ω–∏—Ü–∞? –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω `-sig`?
    
    **–ó–∞–¥–∞–Ω–∏–µ 3.** –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π `b'\xff\xfe'` –≤ –Ω–∞—á–∞–ª–µ. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —Å `encoding='utf-16'`. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ? –≠—Ç–æ BOM ‚Äî –æ–±—ä—è—Å–Ω–∏—Ç–µ –º–µ—Ö–∞–Ω–∏–∑–º.

---

## Troubleshooting: —Ç–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ß–∞—Å—Ç–∏ II

!!! bug "–ö—Ä–∞–∫–æ–∑—è–±—Ä—ã (mojibake) –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞"
    –§–∞–π–ª —á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ –≤ —Ç–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª –∑–∞–ø–∏—Å–∞–Ω.
    
    ```python
    # –®–∞–≥ 1: –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –∫–æ–¥–∏—Ä–æ–≤–∫—É
    import chardet
    with open('file', 'rb') as f:
        result = chardet.detect(f.read())
    print(result)  # {'encoding': 'Windows-1251', 'confidence': 0.99}
    
    # –®–∞–≥ 2: –ø–µ—Ä–µ–∫–æ–¥–∏—Ä—É–π—Ç–µ
    with open('file', encoding=result['encoding']) as f:
        text = f.read()
    ```
    
    –ù–∞ —É—Ä–æ–≤–Ω–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞: `file --mime-encoding file.txt` –ø–æ–∫–∞–∂–µ—Ç –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é –∫–æ–¥–∏—Ä–æ–≤–∫—É.

!!! bug "UnicodeDecodeError –≤ Python"
    ```python
    # –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ—à–∏–±–∫–∏:
    text = data.decode('utf-8', errors='replace')  # –∑–∞–º–µ–Ω–∞ –Ω–∞ ÔøΩ
    
    # –õ—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ ‚Äî –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–¥–∏—Ä–æ–≤–∫—É:
    for enc in ['utf-8', 'cp1251', 'latin-1']:
        try:
            text = data.decode(enc)
            print(f"–°—Ä–∞–±–æ—Ç–∞–ª–æ: {enc}")
            break
        except UnicodeDecodeError:
            continue
    ```

!!! bug "BOM (EF BB BF) –ª–æ–º–∞–µ—Ç JSON / shebang / CSV"
    ```bash
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ BOM:
    xxd file.txt | head -1
    # 00000000: efbb bf7b...  ‚Üê BOM –ø–µ—Ä–µ–¥ { –≤ JSON
    
    # –£–¥–∞–ª–∏—Ç—å BOM:
    sed -i '1s/^\xEF\xBB\xBF//' file.txt
    ```
    –í Python –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `encoding='utf-8-sig'` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ BOM.

!!! bug "–¢–µ—Ä–º–∏–Ω–∞–ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º—É—Å–æ—Ä –≤–º–µ—Å—Ç–æ Unicode"
    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
    
    - `echo $LANG` ‚Äî –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å `UTF-8` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `en_US.UTF-8`)
    - `locale charmap` ‚Äî –¥–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ `UTF-8`
    - –®—Ä–∏—Ñ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω—É–∂–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ Nerd Font –∏–ª–∏ JetBrains Mono)

!!! tip "–°–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞"
    –†–∞–∑–æ–±—Ä–∞–ª–∏—Å—å —Å –∫–æ–¥–∏—Ä–æ–≤–∫–∞–º–∏ –≤ Python. –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–π–¥—ë–º –∫ **—Ñ–æ—Ä–º–∞—Ç–∞–º —Ñ–∞–π–ª–æ–≤** ‚Äî –Ω–∞—á–Ω—ë–º —Å JSON ‚Üí [JSON](../ch3/16-json.md)
