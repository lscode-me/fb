# Глава 13. Вавилонская башня кодировок

## Введение

ASCII прекрасно работает для английского языка, но что делать с кириллицей, иероглифами или арабской вязью? В попытках решить эту проблему человечество создало сотни несовместимых кодировок — настоящую **Вавилонскую башню**, где тексты превращались в «кракозябры» при передаче между системами.

```
Файл в Windows-1251:    Привет
Открыт как ISO-8859-1:  Ïðèâåò
Открыт как KOI8-R:      рТЙЧЕФ

Один и тот же файл — три разных результата!
```

---

## 13.1 Расширение ASCII: 8-битные кодировки

### Проблема 7 бит

ASCII использует только 7 бит (0-127), но байт содержит 8 бит. Это оставляет 128 свободных позиций (128-255), которые разные страны заполнили по-своему.

```
┌─────────────────────────────────────────────────────────────┐
│  Байт: 8 бит = 256 значений                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  0x00-0x7F (0-127):     Стандартный ASCII                   │
│                         Одинаков везде                      │
│                                                             │
│  0x80-0xFF (128-255):   РАСШИРЕННАЯ ЧАСТЬ                   │
│                         Разная в каждой кодировке!          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Что такое CP (Code Page)?

**CP** — это сокращение от **Code Page** (кодовая страница). Этот термин ввела IBM в 1980-х для обозначения таблиц соответствия между байтами и символами.

```
Code Page = таблица из 256 записей
            где каждому байту (0x00–0xFF) соответствует символ

CP437  → Code Page 437 (оригинальная DOS, США)
CP866  → Code Page 866 (DOS, кириллица)
CP1251 → Code Page 1251 (Windows, кириллица)
CP1252 → Code Page 1252 (Windows, Западная Европа)
```

**История нумерации:**

| Диапазон | Происхождение | Примеры |
|----------|---------------|---------|
| 437–869 | IBM PC DOS | cp437 (США), cp866 (кириллица), cp850 (Европа) |
| 874–950 | Windows/DOS Азия | cp932 (Япония), cp949 (Корея), cp950 (Тайвань) |
| 1250–1258 | Windows ANSI | cp1251 (кириллица), cp1252 (Западная Европа) |

Сегодня термин "code page" — это просто синоним "кодировка" в контексте Windows/DOS.

### Семейства кодировок: сводная таблица

| Семейство | Префикс | Создатель | Годы | Где использовалось | Примеры |
|-----------|---------|-----------|------|-------------------|---------|
| **ASCII** | — | ANSI (США) | 1963 | Везде (базовый стандарт) | `ascii` |
| **ISO 8859** | `iso-8859-`, `latin-` | ISO | 1987+ | Unix, Linux, Web (раньше) | `iso-8859-1`, `iso-8859-5`, `iso-8859-15` |
| **Code Pages (DOS)** | `cp`, `ibm` | IBM | 1981+ | MS-DOS, консоль Windows | `cp437`, `cp850`, `cp866` |
| **Code Pages (Windows)** | `cp`, `windows-` | Microsoft | 1990+ | Windows GUI | `cp1251`, `cp1252`, `windows-1251` |
| **KOI8** | `koi8-` | СССР/Россия | 1974/1993 | Unix, email, Рунет 90-х | `koi8-r`, `koi8-u` |
| **Mac** | `mac` | Apple | 1984+ | Mac OS Classic (до OS X) | `mac-roman`, `mac-cyrillic` |
| **UTF** | `utf-` | Unicode Consortium | 1991+ | Современный стандарт | `utf-8`, `utf-16`, `utf-32` |
| **CJK** | `gb`, `big5`, `euc-`, `shift_jis` | Разные | 1980+ | Китай, Япония, Корея | `gb2312`, `gbk`, `big5`, `euc-jp` |

```
Историческая линия:

1963  ASCII (7 бит, только английский)
  │
  ├─→ 1981  CP437 (IBM PC, псевдографика)
  │           └─→ CP850, CP866... (DOS)
  │
  ├─→ 1987  ISO-8859-1 (международный стандарт)
  │           └─→ ISO-8859-2, -5, -15... (разные языки)
  │
  ├─→ 1990  Windows-1252 (Microsoft)
  │           └─→ CP1250, CP1251... (Windows)
  │
  ├─→ 1993  KOI8-R (кириллица для Unix)
  │
  └─→ 1991  Unicode → UTF-8 (1993)
              └─→ Единый стандарт для всех языков
```

### Детальная таблица 8-битных кодировок

| Кодировка | Назначение | Особенности / Комментарии |
|-----------|------------|---------------------------|
| **ISO-8859-1** (Latin-1) | Западная Европа | Стандарт W3C. Основа для Unicode (первые 256 code points). Нет символа € |
| **ISO-8859-15** (Latin-9) | Западная Европа | Latin-1 + символ евро (€), французские Œ, œ, Ÿ |
| **ISO-8859-2** (Latin-2) | Центральная Европа | Польский, чешский, венгерский. Диакритика: ą, ę, ł, ń |
| **ISO-8859-5** | Кириллица (ISO) | Международный стандарт. Редко используется на практике |
| **ISO-8859-7** | Греческий | Современный греческий алфавит |
| **ISO-8859-8** | Иврит | Только согласные (без огласовок). RTL-текст |
| **ISO-8859-9** (Latin-5) | Турецкий | Latin-1 с заменой исландских букв на турецкие (İ, ı, Ş, ş) |
| | | |
| **Windows-1250** | Центральная Европа | Аналог Latin-2 для Windows. Есть типографские кавычки „" |
| **Windows-1251** (CP1251) | Кириллица (Windows) | Стандарт de-facto для русского в Windows. Буквы А-Я идут подряд |
| **Windows-1252** | Западная Европа | Расширение Latin-1. Типографские символы: «», —, €, ™ |
| **Windows-1253** | Греческий | Греческий для Windows |
| **Windows-1254** | Турецкий | Турецкий для Windows |
| **Windows-1255** | Иврит | Иврит для Windows |
| **Windows-1256** | Арабский | Арабский для Windows |
| **Windows-1257** | Балтийский | Латышский, литовский, эстонский |
| | | |
| **KOI8-R** | Русский (Unix) | СССР/Россия. При сбросе 8-го бита → транслитерация (ПРИВЕТ → PRIVET) |
| **KOI8-U** | Украинский | KOI8-R + украинские буквы (і, ї, є, ґ) |
| | | |
| **CP437** | DOS (США) | Оригинальная кодовая страница IBM PC. Псевдографика ░▒▓│┤ |
| **CP850** | DOS (Европа) | Западноевропейские буквы вместо части псевдографики |
| **CP866** | DOS (Россия) | Кириллица для DOS. Псевдографика сохранена |
| | | |
| **MacRoman** | Mac OS Classic | Apple до OS X. Свой набор типографских символов |
| **MacCyrillic** | Mac OS (русский) | Кириллица для классической Mac OS |

!!! warning "Главная проблема"
    Все эти кодировки **несовместимы между собой** в диапазоне 128-255. Байт `0xC0`:
    
    - В CP1251 → `А` (русская заглавная)
    - В KOI8-R → `ю` (русская строчная)
    - В Latin-1 → `À` (французская)
    - В CP437 → `└` (псевдографика)

### Стандарт ISO 8859

ISO разработала серию 8-битных кодировок для разных регионов:

| Кодировка | Регион | Языки |
|-----------|--------|-------|
| **ISO-8859-1** (Latin-1) | Западная Европа | Английский, немецкий, французский, испанский |
| **ISO-8859-2** (Latin-2) | Центральная Европа | Польский, чешский, венгерский |
| **ISO-8859-5** | Кириллица | Русский, болгарский, сербский |
| **ISO-8859-6** | Арабский | Арабский |
| **ISO-8859-7** | Греческий | Греческий |
| **ISO-8859-8** | Иврит | Иврит |
| **ISO-8859-9** (Latin-5) | Турецкий | Турецкий |
| **ISO-8859-15** (Latin-9) | Западная Европа | Latin-1 + евро (€) |

```python
# Пример: буква "ä" в разных кодировках
text = "ä"

# Latin-1 (ISO-8859-1): ä = 0xE4
latin1_bytes = text.encode('iso-8859-1')
print(latin1_bytes)  # b'\xe4'

# Latin-2 (ISO-8859-2): ä = 0xE4 (совпадает)
# Но "ą" (польская) существует только в Latin-2!
```

---

## 13.2 Кириллические кодировки

Для русского языка существовало несколько конкурирующих стандартов — источник бесконечных проблем с «кракозябрами».

### KOI8-R (1993)

**КОИ-8** (Код Обмена Информацией) — советская/российская кодировка.

```
┌─────────────────────────────────────────────────────────────┐
│  KOI8-R: Особенность — порядок букв                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Если отбросить старший бит (0x80 → 0x00):                  │
│                                                             │
│  "ПРИВЕТ" в KOI8-R:  D0 D2 C9 D7 C5 D4                      │
│  Без старшего бита:  50 52 49 57 45 54                      │
│  Это ASCII:          P  R  I  V  E  T                       │
│                                                             │
│  Гениально! Даже на 7-битном канале текст читаем!           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```python
text = "Привет"
koi8 = text.encode('koi8-r')
print(koi8.hex(' '))  # d0 d2 c9 d7 c5 d4

# Трюк с 7-битной совместимостью
ascii_fallback = bytes(b & 0x7F for b in koi8)
print(ascii_fallback)  # b'pRIWET' (почти читаемо!)
```

### Windows-1251 (CP1251)

Кодировка Microsoft для русской Windows:

```python
text = "Привет"
cp1251 = text.encode('windows-1251')
print(cp1251.hex(' '))  # cf f0 e8 e2 e5 f2

# Сравнение одной буквы "П":
print(ord('П'))  # Unicode: 1055
print(text.encode('koi8-r')[0])    # KOI8-R:  208 (0xD0)
print(text.encode('cp1251')[0])    # CP1251:  207 (0xCF)
print(text.encode('iso-8859-5')[0]) # ISO:    191 (0xBF)
```

### ISO-8859-5

Международный стандарт для кириллицы (редко используется):

```python
text = "Привет"
iso = text.encode('iso-8859-5')
print(iso.hex(' '))  # bf e0 d8 d2 d5 e2
```

### Сравнение кодировок

| Символ | KOI8-R | CP1251 | ISO-8859-5 | Unicode |
|--------|--------|--------|------------|---------|
| А | 0xE1 | 0xC0 | 0xB0 | U+0410 |
| Б | 0xE2 | 0xC1 | 0xB1 | U+0411 |
| В | 0xF7 | 0xC2 | 0xB2 | U+0412 |
| а | 0xC1 | 0xE0 | 0xD0 | U+0430 |
| б | 0xC2 | 0xE1 | 0xD1 | U+0431 |
| в | 0xD7 | 0xE2 | 0xD2 | U+0432 |

Одни и те же символы — разные байты!

### Полная таблица символов 128-255

Ниже — полная таблица верхней половины (0x80-0xFF) для трёх основных кодировок кириллицы. Первые 128 символов (0x00-0x7F) одинаковы — это ASCII.

??? note "Таблица символов 0x80-0xFF (нажмите, чтобы развернуть)"

    #### Строки 0x80-0x8F
    
    | Hex | Dec | CP1251 | KOI8-R | ISO-8859-5 | Latin-1 |
    |-----|-----|--------|--------|------------|---------|
    | 80 | 128 | Ђ | ─ | · | · |
    | 81 | 129 | Ѓ | │ | · | · |
    | 82 | 130 | ‚ | ┌ | · | · |
    | 83 | 131 | ѓ | ┐ | · | · |
    | 84 | 132 | „ | └ | · | · |
    | 85 | 133 | … | ┘ | · | · |
    | 86 | 134 | † | ├ | · | · |
    | 87 | 135 | ‡ | ┤ | · | · |
    | 88 | 136 | € | ┬ | · | · |
    | 89 | 137 | ‰ | ┴ | · | · |
    | 8A | 138 | Љ | ┼ | · | · |
    | 8B | 139 | ‹ | ▀ | · | · |
    | 8C | 140 | Њ | ▄ | · | · |
    | 8D | 141 | Ќ | █ | · | · |
    | 8E | 142 | Ћ | ▌ | · | · |
    | 8F | 143 | Џ | ▐ | · | · |

    #### Строки 0x90-0x9F
    
    | Hex | Dec | CP1251 | KOI8-R | ISO-8859-5 | Latin-1 |
    |-----|-----|--------|--------|------------|---------|
    | 90 | 144 | ђ | ░ | · | · |
    | 91 | 145 | ' | ▒ | · | · |
    | 92 | 146 | ' | ▓ | · | · |
    | 93 | 147 | " | ⌠ | · | · |
    | 94 | 148 | " | ■ | · | · |
    | 95 | 149 | • | ∙ | · | · |
    | 96 | 150 | – | √ | · | · |
    | 97 | 151 | — | ≈ | · | · |
    | 98 | 152 | · | ≤ | · | · |
    | 99 | 153 | ™ | ≥ | · | · |
    | 9A | 154 | љ |   | · | · |
    | 9B | 155 | › | ⌡ | · | · |
    | 9C | 156 | њ | ° | · | · |
    | 9D | 157 | ќ | ² | · | · |
    | 9E | 158 | ћ | · | · | · |
    | 9F | 159 | џ | ÷ | · | · |

    #### Строки 0xA0-0xAF
    
    | Hex | Dec | CP1251 | KOI8-R | ISO-8859-5 | Latin-1 |
    |-----|-----|--------|--------|------------|---------|
    | A0 | 160 | (nbsp) | (nbsp) | (nbsp) | (nbsp) |
    | A1 | 161 | Ў | Ё | Ё | ¡ |
    | A2 | 162 | ў | ё | Ђ | ¢ |
    | A3 | 163 | Ј | ₴ | Ѓ | £ |
    | A4 | 164 | ¤ | є | Є | ¤ |
    | A5 | 165 | Ґ | ї | Ѕ | ¥ |
    | A6 | 166 | ¦ | і | І | ¦ |
    | A7 | 167 | § | § | Ї | § |
    | A8 | 168 | Ё | ・ | Ј | ¨ |
    | A9 | 169 | © | © | Љ | © |
    | AA | 170 | Є | ₴ | Њ | ª |
    | AB | 171 | « | « | Ћ | « |
    | AC | 172 | ¬ | ¬ | Ќ | ¬ |
    | AD | 173 | (shy) | (shy) | (shy) | (shy) |
    | AE | 174 | ® | ® | Ў | ® |
    | AF | 175 | Ї | ї | Џ | ¯ |

    #### Строки 0xB0-0xBF (начало кириллицы в ISO-8859-5)
    
    | Hex | Dec | CP1251 | KOI8-R | ISO-8859-5 | Latin-1 |
    |-----|-----|--------|--------|------------|---------|
    | B0 | 176 | ° | ° | А | ° |
    | B1 | 177 | ± | ± | Б | ± |
    | B2 | 178 | І | ² | В | ² |
    | B3 | 179 | і | Ё | Г | ³ |
    | B4 | 180 | ґ | є | Д | ´ |
    | B5 | 181 | µ | µ | Е | µ |
    | B6 | 182 | ¶ | ¶ | Ж | ¶ |
    | B7 | 183 | · | · | З | · |
    | B8 | 184 | ё | ё | И | ¸ |
    | B9 | 185 | № | № | Й | ¹ |
    | BA | 186 | є | є | К | º |
    | BB | 187 | » | » | Л | » |
    | BC | 188 | ј | ј | М | ¼ |
    | BD | 189 | Ѕ | ѕ | Н | ½ |
    | BE | 190 | ѕ | ѕ | О | ¾ |
    | BF | 191 | ї | © | П | ¿ |

    #### Строки 0xC0-0xCF (заглавные буквы в CP1251)
    
    | Hex | Dec | CP1251 | KOI8-R | ISO-8859-5 | Latin-1 |
    |-----|-----|--------|--------|------------|---------|
    | C0 | 192 | **А** | ю | Р | À |
    | C1 | 193 | **Б** | **а** | С | Á |
    | C2 | 194 | **В** | **б** | Т | Â |
    | C3 | 195 | **Г** | ц | У | Ã |
    | C4 | 196 | **Д** | д | Ф | Ä |
    | C5 | 197 | **Е** | **е** | Х | Å |
    | C6 | 198 | **Ж** | ф | Ц | Æ |
    | C7 | 199 | **З** | г | Ч | Ç |
    | C8 | 200 | **И** | х | Ш | È |
    | C9 | 201 | **Й** | **и** | Щ | É |
    | CA | 202 | **К** | й | Ъ | Ê |
    | CB | 203 | **Л** | к | Ы | Ë |
    | CC | 204 | **М** | л | Ь | Ì |
    | CD | 205 | **Н** | м | Э | Í |
    | CE | 206 | **О** | н | Ю | Î |
    | CF | 207 | **П** | **о** | Я | Ï |

    #### Строки 0xD0-0xDF
    
    | Hex | Dec | CP1251 | KOI8-R | ISO-8859-5 | Latin-1 |
    |-----|-----|--------|--------|------------|---------|
    | D0 | 208 | **Р** | **п** | а | Ð |
    | D1 | 209 | **С** | я | б | Ñ |
    | D2 | 210 | **Т** | р | в | Ò |
    | D3 | 211 | **У** | с | г | Ó |
    | D4 | 212 | **Ф** | **т** | д | Ô |
    | D5 | 213 | **Х** | **у** | е | Õ |
    | D6 | 214 | **Ц** | ж | ж | Ö |
    | D7 | 215 | **Ч** | **в** | з | × |
    | D8 | 216 | **Ш** | ь | и | Ø |
    | D9 | 217 | **Щ** | ы | й | Ù |
    | DA | 218 | **Ъ** | з | к | Ú |
    | DB | 219 | **Ы** | ш | л | Û |
    | DC | 220 | **Ь** | э | м | Ü |
    | DD | 221 | **Э** | щ | н | Ý |
    | DE | 222 | **Ю** | ч | о | Þ |
    | DF | 223 | **Я** | ъ | п | ß |

    #### Строки 0xE0-0xEF (строчные буквы в CP1251)
    
    | Hex | Dec | CP1251 | KOI8-R | ISO-8859-5 | Latin-1 |
    |-----|-----|--------|--------|------------|---------|
    | E0 | 224 | **а** | Ю | р | à |
    | E1 | 225 | **б** | **А** | с | á |
    | E2 | 226 | **в** | **Б** | т | â |
    | E3 | 227 | **г** | Ц | у | ã |
    | E4 | 228 | **д** | Д | ф | ä |
    | E5 | 229 | **е** | **Е** | х | å |
    | E6 | 230 | **ж** | Ф | ц | æ |
    | E7 | 231 | **з** | Г | ч | ç |
    | E8 | 232 | **и** | Х | ш | è |
    | E9 | 233 | **й** | **И** | щ | é |
    | EA | 234 | **к** | Й | ъ | ê |
    | EB | 235 | **л** | К | ы | ë |
    | EC | 236 | **м** | Л | ь | ì |
    | ED | 237 | **н** | М | э | í |
    | EE | 238 | **о** | Н | ю | î |
    | EF | 239 | **п** | **О** | я | ï |

    #### Строки 0xF0-0xFF
    
    | Hex | Dec | CP1251 | KOI8-R | ISO-8859-5 | Latin-1 |
    |-----|-----|--------|--------|------------|---------|
    | F0 | 240 | **р** | **П** | № | ð |
    | F1 | 241 | **с** | Я | ё | ñ |
    | F2 | 242 | **т** | **Р** | ђ | ò |
    | F3 | 243 | **у** | С | ѓ | ó |
    | F4 | 244 | **ф** | **Т** | є | ô |
    | F5 | 245 | **х** | **У** | ѕ | õ |
    | F6 | 246 | **ц** | Ж | і | ö |
    | F7 | 247 | **ч** | **В** | ї | ÷ |
    | F8 | 248 | **ш** | Ь | ј | ø |
    | F9 | 249 | **щ** | Ы | љ | ù |
    | FA | 250 | **ъ** | З | њ | ú |
    | FB | 251 | **ы** | Ш | ћ | û |
    | FC | 252 | **ь** | Э | ќ | ü |
    | FD | 253 | **э** | Щ | § | ý |
    | FE | 254 | **ю** | Ч | ў | þ |
    | FF | 255 | **я** | Ъ | џ | ÿ |

    !!! info "Обратите внимание"
        - **CP1251**: Кириллица расположена компактно (А-Я: 0xC0-0xDF, а-я: 0xE0-0xFF)
        - **KOI8-R**: Кириллица перемешана так, что при сбросе 8-го бита получается транслитерация
        - **ISO-8859-5**: Кириллица начинается с 0xB0 (А) и идёт последовательно
        - **Latin-1**: Нет кириллицы — западноевропейские символы (À, Á, Ñ, ß...)

### Генерация таблицы программно

```python
# Сгенерировать таблицу символов для любой кодировки
def print_encoding_table(encoding, start=0x80, end=0xFF):
    """Выводит таблицу символов для указанной кодировки."""
    print(f"\n{encoding.upper()} (0x{start:02X}-0x{end:02X}):")
    print("-" * 50)
    
    for row in range(start, end + 1, 16):
        chars = []
        for col in range(16):
            byte_val = row + col
            if byte_val > end:
                break
            try:
                char = bytes([byte_val]).decode(encoding)
                # Заменяем непечатные символы
                if char.isprintable() and not char.isspace():
                    chars.append(char)
                else:
                    chars.append('·')
            except:
                chars.append('×')
        
        hex_row = f"0x{row:02X}"
        print(f"{hex_row}: {' '.join(chars)}")

# Примеры использования
print_encoding_table('cp1251')
print_encoding_table('koi8-r')
print_encoding_table('iso-8859-5')
print_encoding_table('latin-1')
```

Результат для CP1251:
```
CP1251 (0x80-0xFF):
--------------------------------------------------
0x80: Ђ Ѓ ‚ ѓ „ … † ‡ € ‰ Љ ‹ Њ Ќ Ћ Џ
0x90: ђ ' ' " " • – — · ™ љ › њ ќ ћ џ
0xA0: · Ў ў Ј ¤ Ґ ¦ § Ё © Є « ¬ · ® Ї
0xB0: ° ± І і ґ µ ¶ · ё № є » ј Ѕ ѕ ї
0xC0: А Б В Г Д Е Ж З И Й К Л М Н О П
0xD0: Р С Т У Ф Х Ц Ч Ш Щ Ъ Ы Ь Э Ю Я
0xE0: а б в г д е ж з и й к л м н о п
0xF0: р с т у ф х ц ч ш щ ъ ы ь э ю я
```

---

## 13.3 Азиатские кодировки

Для языков с тысячами символов 8 бит недостаточно.

### Многобайтные кодировки

```
┌─────────────────────────────────────────────────────────────┐
│  ПРОБЛЕМА: 256 значений недостаточно                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Китайский:  > 50,000 иероглифов                            │
│  Японский:   Хирагана + Катакана + Кандзи                   │
│  Корейский:  Хангыль + Ханча                                │
│                                                             │
│  РЕШЕНИЕ: Многобайтные кодировки                            │
│                                                             │
│  • Shift_JIS (Япония)                                       │
│  • EUC-JP, EUC-KR, EUC-CN                                   │
│  • Big5 (Традиционный китайский)                            │
│  • GB2312, GBK, GB18030 (Упрощённый китайский)              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Shift_JIS (Япония)

```python
text = "日本語"  # "Японский язык"

sjis = text.encode('shift_jis')
print(sjis.hex(' '))  # 93 fa 96 7b 8c ea
print(len(sjis))      # 6 байт (по 2 на иероглиф)

# ASCII-совместимость сохранена
mixed = "Hello日本"
sjis_mixed = mixed.encode('shift_jis')
print(sjis_mixed)  # b'Hello\x93\xfa\x96{'
# "Hello" осталось как ASCII!
```

### GB2312 и GBK (Китай)

```python
text = "中文"  # "Китайский"

gb = text.encode('gb2312')
print(gb.hex(' '))  # d6 d0 ce c4

gbk = text.encode('gbk')  # Расширенная версия
print(gbk.hex(' '))  # d6 d0 ce c4
```

### Проблема: Mojibake (文字化け)

Когда японский термин **mojibake** стал международным — это говорит о масштабе проблемы!

```python
# Текст в Shift_JIS открыт как Windows-1251
original = "日本語"
sjis_bytes = original.encode('shift_jis')

# Попытка декодировать как CP1251
try:
    wrong = sjis_bytes.decode('cp1251')
    print(wrong)  # "Ук–{Њк" — кракозябры!
except:
    pass
```

---

## 13.4 Проблемы множественных кодировок

### Кракозябры (Mojibake)

```
┌─────────────────────────────────────────────────────────────┐
│                    ПРОЯВЛЕНИЯ                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  "Привет" (CP1251) → "Ïðèâåò" (Latin-1)                     │
│  "Привет" (KOI8-R) → "рТЙЧЕФ" (CP1251)                      │
│  "日本語" (UTF-8)  → "æ—¥æœ¬èªž" (Latin-1)                   │
│                                                             │
│  Причина: неверная интерпретация байтов                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Невозможность смешивания

```python
# НЕЛЬЗЯ: смешать русский и греческий в одной 8-битной кодировке
russian = "Привет"
greek = "Γειά"

# ISO-8859-5 (кириллица) не содержит греческих букв
# ISO-8859-7 (греческий) не содержит кириллицы

try:
    russian.encode('iso-8859-7')  # UnicodeEncodeError!
except UnicodeEncodeError as e:
    print(f"Ошибка: {e}")
```

### Потеря данных

```python
# Символ € (евро) появился позже Latin-1
text = "Цена: 100€"

# ISO-8859-1 не знает символ €
try:
    text.encode('iso-8859-1')
except UnicodeEncodeError:
    print("Символ € не существует в Latin-1!")

# ISO-8859-15 — обновлённая версия с €
encoded = text.encode('iso-8859-15')  # OK
```

### Определение кодировки

```python
# Как узнать кодировку файла?
# НИКАК — кодировка не хранится в файле!

# Библиотека chardet пытается угадать
# pip install chardet

import chardet

with open('mystery.txt', 'rb') as f:
    raw = f.read()
    result = chardet.detect(raw)
    print(result)
    # {'encoding': 'KOI8-R', 'confidence': 0.87, 'language': 'Russian'}

# Только эвристика с вероятностью!
```

---

## 13.5 Решения до Unicode

### MIME и Content-Type

В email и HTTP кодировка указывается явно:

```
Content-Type: text/plain; charset=windows-1251
Content-Type: text/html; charset=utf-8
```

### HTML meta

```html
<!-- Старый способ -->
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">

<!-- HTML5 -->
<meta charset="utf-8">
```

### XML declaration

```xml
<?xml version="1.0" encoding="windows-1251"?>
```

### BOM (Byte Order Mark)

Некоторые кодировки используют специальную сигнатуру в начале файла:

```
UTF-8 BOM:     EF BB BF
UTF-16 LE:     FF FE
UTF-16 BE:     FE FF
UTF-32 LE:     FF FE 00 00
UTF-32 BE:     00 00 FE FF
```

```python
# Проверка BOM
with open('file.txt', 'rb') as f:
    start = f.read(4)
    
    if start[:3] == b'\xef\xbb\xbf':
        print("UTF-8 с BOM")
    elif start[:2] == b'\xff\xfe':
        print("UTF-16 LE")
    elif start[:2] == b'\xfe\xff':
        print("UTF-16 BE")
```

---

## 13.6 Практика: Конвертация кодировок

### Python

```python
def convert_encoding(input_path, output_path, 
                     from_enc='cp1251', to_enc='utf-8'):
    """Конвертация файла между кодировками"""
    with open(input_path, 'r', encoding=from_enc) as f:
        content = f.read()
    
    with open(output_path, 'w', encoding=to_enc) as f:
        f.write(content)

# Использование
convert_encoding('old_russian.txt', 'modern.txt', 
                 from_enc='koi8-r', to_enc='utf-8')
```

### Командная строка

```bash
# iconv — стандартная утилита
$ iconv -f cp1251 -t utf-8 input.txt > output.txt

# Список доступных кодировок
$ iconv -l

# С обработкой ошибок
$ iconv -f cp1251 -t utf-8//TRANSLIT input.txt > output.txt

# Рекурсивная конвертация
$ find . -name "*.txt" -exec sh -c \
    'iconv -f cp1251 -t utf-8 "$1" > "$1.utf8"' _ {} \;
```

### Strconv и автоопределение

```bash
# enca — определение и конвертация
$ enca -L russian mystery.txt
# KOI8-R

$ enca -x utf-8 < koi8-file.txt > utf8-file.txt
```

---

## 13.7 Хронология кодировок

```
1963    ASCII (7 бит, 128 символов)
        │
1970-е  │ Национальные расширения (проприетарные)
        │
1980-е  ├─ KOI8 (СССР)
        ├─ Code pages (IBM, Microsoft)
        │
1987    └─ ISO 8859-1 (Latin-1)
        
1991    ┌─ Unicode 1.0 (16 бит, 7,161 символов)
        │
1993    ├─ KOI8-R (RFC 1489)
        │
1996    ├─ Unicode 2.0 + UTF-8
        │
1998    ├─ Windows-1251 (доминирует в Рунете)
        │
2000-е  │  Переход на UTF-8
        │
2010-е  │  UTF-8 становится стандартом
        │
Сейчас  └─ UTF-8 = 98% веба
```

---

## Резюме

**Ключевые проблемы эпохи множественных кодировок:**

1. **Несовместимость** — один и тот же байт означает разные символы
2. **Невозможность смешивания** — нельзя объединить тексты на разных языках
3. **Отсутствие метаданных** — кодировка не хранится в файле
4. **Потеря данных** — при неправильной конвертации
5. **Кракозябры** — неверная интерпретация

**Следствие:** Необходим единый универсальный стандарт → **Unicode**

---

## Глоссарий

| Термин | Значение |
|--------|----------|
| **Code page** | Таблица соответствия байтов символам (Microsoft) |
| **Charset** | Набор символов (character set) |
| **Encoding** | Способ представления символов в байтах |
| **Mojibake** | Кракозябры (японский термин) |
| **BOM** | Byte Order Mark — сигнатура кодировки |
| **Transcoding** | Конвертация между кодировками |


??? question "Упражнения"
    **Задание 1.** Создайте файл с кириллицей в CP1251 (`iconv -f UTF-8 -t CP1251`) и откройте его как UTF-8. Получили «кракозябры»? Декодируйте обратно.
    
    **Задание 2.** Напишите Python-скрипт, который определяет кодировку файла с помощью библиотеки `chardet`. Протестируйте на файлах в CP1251, KOI8-R, UTF-8.
    
    **Задание 3.** Объясните, почему KOI8-R при сбросе 8-го бита даёт читаемую транслитерацию (например, "П" → "p"). Покажите это на примере 3 букв.

!!! tip "Следующая глава"
    Проблема множественных кодировок привела к созданию **Unicode** — единого стандарта для всех символов мира → [Unicode и UTF-8](14-unicode-utf8.md)
