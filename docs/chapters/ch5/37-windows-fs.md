# Глава 37. Файловые системы Windows

## Введение

Windows использует собственное семейство файловых систем, оптимизированных под экосистему Microsoft. Понимание FAT, NTFS и ReFS важно для работы с Windows-системами и обмена данными между платформами.

---

## 37.1 Эволюция файловых систем Windows

```
1977  ──▶  FAT12 (дискеты)
1984  ──▶  FAT16 (жёсткие диски до 2 GB)
1996  ──▶  FAT32 (до 32 GB, файлы до 4 GB)
1993  ──▶  NTFS (Windows NT)
2012  ──▶  ReFS (Windows Server 2012)
2017  ──▶  exFAT (флешки, SD-карты)
```

---

## 37.2 FAT (File Allocation Table)

### Структура FAT

```
┌────────────────────────────────────┐
│  Boot Sector                       │
├────────────────────────────────────┤
│  FAT #1 (таблица размещения)       │
├────────────────────────────────────┤
│  FAT #2 (резервная копия)          │
├────────────────────────────────────┤
│  Root Directory (только FAT12/16)  │
├────────────────────────────────────┤
│  Data Area                         │
└────────────────────────────────────┘
```

### FAT таблица

```
Кластер 0:  Media Type
Кластер 1:  End of Chain marker
Кластер 2:  → 5     (файл продолжается в кластере 5)
Кластер 3:  FREE
Кластер 4:  → EOF   (конец файла)
Кластер 5:  → 4     (продолжение → кластер 4)
```

### Ограничения FAT

| Версия | Размер кластера | Max файл | Max раздел |
|--------|-----------------|----------|------------|
| FAT12 | 512 B - 8 KB | 32 MB | 32 MB |
| FAT16 | 512 B - 64 KB | 2 GB | 2 GB |
| FAT32 | 512 B - 32 KB | 4 GB - 1 B | 2 TB |

### Работа с FAT в Linux

```bash
# Создание FAT32
mkfs.vfat -F 32 /dev/sdb1

# С меткой
mkfs.vfat -F 32 -n "FLASHDRIVE" /dev/sdb1

# Проверка
fsck.vfat /dev/sdb1

# Монтирование с кодировкой
mount -t vfat -o iocharset=utf8 /dev/sdb1 /mnt
```

---

## 37.3 exFAT

**exFAT** — современная FAT для флешек и SD-карт.

### Преимущества exFAT

- **Нет лимита в 4 GB** на файл (до 16 EB)
- **Кроссплатформенность** (Windows, macOS, Linux)
- **Лицензия** от Microsoft (с 2019 — open source спецификация)
- **Оптимизация** для flash-памяти

```bash
# Создание exFAT
mkfs.exfat /dev/sdb1

# С меткой
mkfs.exfat -n "EXTERNAL" /dev/sdb1

# Монтирование
mount -t exfat /dev/sdb1 /mnt
```

---

## 37.4 NTFS (New Technology File System)

### Ключевые возможности NTFS

- **Журналирование** метаданных
- **Поддержка ACL** (Access Control Lists)
- **Шифрование** (EFS — Encrypting File System)
- **Сжатие** на уровне файла/папки
- **Квоты** дискового пространства
- **Hard links и symbolic links**
- **Sparse files**
- **Alternative Data Streams (ADS)**

### Структура NTFS

```
┌────────────────────────────────────────┐
│  Boot Sector                           │
├────────────────────────────────────────┤
│  Master File Table (MFT)               │
│  ├── $MFT        (сама MFT)            │
│  ├── $MFTMirr    (зеркало первых 4)    │
│  ├── $LogFile    (журнал)              │
│  ├── $Volume     (метаданные тома)     │
│  ├── $AttrDef    (определения атрибутов)│
│  ├── $Root       (корневой каталог)    │
│  ├── $Bitmap     (карта занятости)     │
│  ├── $Boot       (загрузочный сектор)  │
│  ├── $BadClus    (плохие кластеры)     │
│  ├── $Secure     (дескрипторы безоп.)  │
│  └── ...файлы пользователя...          │
├────────────────────────────────────────┤
│  Data Area                             │
└────────────────────────────────────────┘
```

### MFT Record

Каждый файл — это запись в MFT (обычно 1 KB):

```
┌─────────────────────────────────────┐
│  Header (42 bytes)                  │
├─────────────────────────────────────┤
│  $STANDARD_INFORMATION              │
│  (времена, флаги, версия)           │
├─────────────────────────────────────┤
│  $FILE_NAME                         │
│  (имя файла в UTF-16)               │
├─────────────────────────────────────┤
│  $DATA                              │
│  (содержимое или ссылка на кластеры)│
├─────────────────────────────────────┤
│  $SECURITY_DESCRIPTOR (optional)    │
└─────────────────────────────────────┘
```

### Resident vs Non-resident

```
Малый файл (< ~700 байт):
┌─────────────────────────────────────┐
│  MFT Record                         │
│  ├── Header                         │
│  ├── $STANDARD_INFORMATION          │
│  ├── $FILE_NAME                     │
│  └── $DATA: "Содержимое файла"      │  ← Resident
└─────────────────────────────────────┘

Большой файл:
┌─────────────────────────────────────┐
│  MFT Record                         │
│  ├── Header                         │
│  ├── $STANDARD_INFORMATION          │
│  ├── $FILE_NAME                     │
│  └── $DATA: Run List                │  ← Non-resident
│       [Cluster 1000, Length 50]     │
│       [Cluster 2000, Length 100]    │
└─────────────────────────────────────┘
```

### Alternative Data Streams (ADS)

```cmd
REM Создание ADS в Windows
echo "Скрытые данные" > file.txt:hidden

REM Чтение ADS
more < file.txt:hidden

REM Просмотр ADS
dir /r file.txt
```

```bash
# В Linux с ntfs-3g
getfattr -d file.txt
cat file.txt:hidden
```

### NTFS в Linux

```bash
# Монтирование (ntfs-3g)
mount -t ntfs-3g /dev/sdb1 /mnt

# С правами
mount -t ntfs-3g -o uid=1000,gid=1000,umask=022 /dev/sdb1 /mnt

# Создание NTFS
mkfs.ntfs -f /dev/sdb1  # быстрое форматирование
mkfs.ntfs /dev/sdb1     # полное (медленное)

# Проверка
ntfsfix /dev/sdb1  # базовое исправление
# Для полной проверки: chkdsk в Windows
```

---

## 37.5 ReFS (Resilient File System)

### Особенности ReFS

- **Целостность данных** (checksums)
- **Автоматическое восстановление** при повреждении
- **Масштабируемость** (до 35 PB)
- **Интеграция со Storage Spaces**

### Ограничения ReFS

- Нет сжатия, шифрования (EFS)
- Нет загрузки с ReFS
- Нет съёмных носителей
- Только Windows Server / Windows 10 Pro for Workstations

```
Максимальный размер файла:     35 PB
Максимальный размер тома:      35 PB
Максимальная длина пути:       32767 символов
```

---

## 37.6 Сравнение файловых систем Windows

| Характеристика | FAT32 | exFAT | NTFS | ReFS |
|----------------|-------|-------|------|------|
| Max файл | 4 GB | 16 EB | 16 TB | 35 PB |
| Max том | 2 TB | 128 PB | 256 TB | 35 PB |
| Журнал | ❌ | ❌ | ✅ | ✅ |
| Права доступа | ❌ | ❌ | ✅ | ✅ |
| Шифрование | ❌ | ❌ | ✅ (EFS) | ❌ |
| Сжатие | ❌ | ❌ | ✅ | ❌ |
| Linux поддержка | ✅ | ✅ | ✅ (ntfs-3g) | ❌ |
| macOS поддержка | ✅ | ✅ | Только чтение | ❌ |

### Рекомендации по использованию

| Сценарий | Рекомендуемая ФС |
|----------|------------------|
| USB-флешка (совместимость) | exFAT |
| Внешний диск (только Windows) | NTFS |
| Системный диск Windows | NTFS |
| SD-карта для камеры | FAT32 или exFAT |
| Сервер Windows с важными данными | ReFS |
| Обмен файлами Windows-Linux-Mac | exFAT |

---

## Резюме

```
FAT32   →  Максимальная совместимость, ограничение 4 GB
exFAT   →  Современная замена FAT32 для съёмных носителей
NTFS    →  Стандарт для Windows, журнал + права + шифрование
ReFS    →  Серверная ФС с целостностью данных
```

??? question "Упражнения"
    **Задание 1.** Создайте FAT32 на USB-флешке. Какие ограничения? Попробуйте скопировать файл > 4 ГБ. Попробуйте exFAT — решает ли проблему?
    
    **Задание 2.** Исследуйте NTFS Alternate Data Streams: `echo "hidden" > file.txt:secret`. Прочитайте: `more < file.txt:secret`. Видите ли вы ADS в проводнике?
    
    **Задание 3.** Сравните FAT32, exFAT и NTFS: максимальный размер файла, журналирование, права доступа. Когда какую ФС выбрать?
